@model IEnumerable<BankManagementSystem.Models.Branch>

@{
    ViewData["Title"] = "Branches";
    int currentPage = ViewBag.CurrentPage ?? 1;
    int totalPages = ViewBag.TotalPages ?? 1;
    int pageSize = ViewBag.PageSize ?? 10;
    string searchString = ViewBag.CurrentFilter ?? "";
    int totalRecords = ViewBag.TotalRecords ?? 0;
    int startRecord = Model.Any() ? ((currentPage - 1) * pageSize) + 1 : 0;
    int endRecord = Model.Any() ? Math.Min(startRecord + Model.Count() - 1, totalRecords) : 0;
}

<!-- Header -->
<div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-5">
    <div>
        <h2 class="fw-bold mb-1">Branch Management</h2>
        <p class="text-muted mb-0">Overview of all bank branches</p>
    </div>
    <a asp-action="CreateOrEdit" class="btn btn-primary btn-lg px-4 shadow-sm mt-3 mt-md-0">
        <i class="bi bi-plus-lg me-2"></i> Add New Branch
    </a>
</div>

<!-- Quick Stats -->
<div class="row g-4 mb-5">
    <div class="col-xl-3 col-lg-6">
        <div class="stat-card p-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <p class="text-muted mb-1 small">Total Branches</p>
                    <h4 class="fw-bold mb-1">@totalRecords</h4>
                </div>
                <i class="bi bi-buildings fs-3 text-primary opacity-75"></i>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-lg-6">
        <div class="stat-card p-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <p class="text-muted mb-1 small">Showing Now</p>
                    <h4 class="fw-bold mb-1">@Model.Count()</h4>
                </div>
                <i class="bi bi-eye fs-3 text-success opacity-75"></i>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-lg-6">
        <div class="stat-card p-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <p class="text-muted mb-1 small">Current Page</p>
                    <h4 class="fw-bold mb-1">@currentPage <small class="text-muted">of @totalPages</small></h4>
                </div>
                <i class="bi bi-file-earmark-text fs-3 text-info opacity-75"></i>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-lg-6">
        <div class="stat-card p-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <p class="text-muted mb-1 small">Records Range</p>
                    <h4 class="fw-bold mb-1">@startRecord–@endRecord</h4>
                </div>
                <i class="bi bi-list-check fs-3 text-warning opacity-75"></i>
            </div>
        </div>
    </div>
</div>

<!-- Search & Controls -->
<div class="card shadow mb-5">
    <div class="card-body">
        <div class="row g-3 align-items-end">
            <div class="col-md-5 col-lg-4">
                <div class="input-group input-group-lg">
                    <span class="input-group-text bg-transparent border-end-0">
                        <i class="bi bi-search text-muted"></i>
                    </span>
                    <input type="search" class="form-control border-start-0"
                           id="searchInput" placeholder="Search branch name or code..."
                           value="@searchString">
                </div>
            </div>
            <div class="col-md-3 col-lg-2">
                <select class="form-select form-select-lg" id="pageSizeSelect">
                    <option value="10">10 per page</option>
                    <option value="25">25 per page</option>
                    <option value="50">50 per page</option>
                    <option value="100">100 per page</option>
                </select>

            </div>
            <div class="col-md-auto ms-auto">
                <button class="btn btn-primary btn-lg px-5" id="searchBtn">
                    <i class="bi bi-search me-2"></i>Search
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Main Table Card -->
<div class="dashboard-card overflow-hidden shadow">
    <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-3 bg-gradient-primary-soft">
        <h5 class="card-title mb-0">All Branches</h5>
        <div class="text-muted small">
            Showing @startRecord–@endRecord of @totalRecords branches
        </div>
    </div>

    <div class="table-responsive">
        @if (!Model.Any())
        {
            <div class="text-center py-8">
                <i class="bi bi-building-slash display-1 text-muted mb-4 d-block"></i>
                <h5 class="text-muted mb-3">No branches found</h5>
                <p class="text-muted mb-4">
                    @(string.IsNullOrEmpty(searchString)
                        ? "Start by adding your first branch"
                        : $"No results for \"{searchString}\"")
                </p>
                <a asp-action="CreateOrEdit" class="btn btn-primary px-5">
                    <i class="bi bi-plus-lg me-2"></i>Add First Branch
                </a>
            </div>
        }
        else
        {
            <table class="table table-hover mb-0 align-middle">
                <thead class="table-light sticky-top">
                    <tr>
                        <th class="text-center" style="width: 70px;">SL#</th>
                        <th class="ps-4">Code</th>
                        <th>Name</th>
                        <th>Address</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        int sl = startRecord; // Start from current pagination offset
                    }
                    @foreach (var branch in Model)
                    {
                        <tr>
                            <td class="text-center">
                                <span class="badge bg-secondary rounded-pill">@sl</span>
                            </td>
                            <td class="ps-4 fw-medium">@branch.BranchCode</td>
                            <td>
                                <div class="fw-semibold">@branch.BranchName</div>
                                <small class="text-muted">ID: @branch.Id</small>
                            </td>
                            <td class="text-muted small">
                                @(branch.Address.Length > 70 ? branch.Address.Substring(0, 70) + "..." : branch.Address)
                            </td>
                            <td>
                                <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 px-3 py-1">
                                    Active
                                </span>
                            </td>
                            <td class="text-muted small">
                                @branch.CreatedAt.ToString("dd MMM yyyy")
                                <br>
                                <small>@branch.CreatedAt.ToString("hh:mm tt")</small>
                            </td>
                            <td class="text-center">
                                <div class="btn-group btn-group-sm">
                                    <a asp-action="Details" asp-route-id="@branch.Id"
                                       class="btn btn-outline-info" title="View">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <a asp-action="CreateOrEdit" asp-route-id="@branch.Id"
                                       class="btn btn-outline-warning" title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <form asp-action="Delete" asp-route-id="@branch.Id" method="post" class="d-inline">
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="btn btn-outline-danger"
                                                onclick="return confirm('Delete @branch.BranchName?')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        sl++;
                    }
                </tbody>
            </table>
        }
    </div>

    <!-- Pagination -->
    @if (totalPages > 1)
    {
        <div class="card-footer bg-transparent border-0 px-4 py-3">
            <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
                <div class="text-muted small">
                    Showing <strong>@startRecord–@endRecord</strong> of <strong>@totalRecords</strong>
                </div>
                <nav>
                    <ul class="pagination pagination-sm mb-0">
                        <li class="page-item @(currentPage <= 1 ? "disabled" : "")">
                            <a class="page-link" asp-action="Index" asp-route-page="1"
                               asp-route-searchString="@searchString" asp-route-pageSize="@pageSize">First</a>
                        </li>
                        <li class="page-item @(currentPage <= 1 ? "disabled" : "")">
                            <a class="page-link" asp-action="Index" asp-route-page="@(currentPage - 1)"
                               asp-route-searchString="@searchString" asp-route-pageSize="@pageSize">Previous</a>
                        </li>

                        @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(totalPages, currentPage + 2); i++)
                        {
                            <li class="page-item @(i == currentPage ? "active" : "")">
                                <a class="page-link" asp-action="Index" asp-route-page="@i"
                                   asp-route-searchString="@searchString" asp-route-pageSize="@pageSize">@i</a>
                            </li>
                        }

                        <li class="page-item @(currentPage >= totalPages ? "disabled" : "")">
                            <a class="page-link" asp-action="Index" asp-route-page="@(currentPage + 1)"
                               asp-route-searchString="@searchString" asp-route-pageSize="@pageSize">Next</a>
                        </li>
                        <li class="page-item @(currentPage >= totalPages ? "disabled" : "")">
                            <a class="page-link" asp-action="Index" asp-route-page="@totalPages"
                               asp-route-searchString="@searchString" asp-route-pageSize="@pageSize">Last</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    }
</div>

@section Styles {
    <style>
        .bg-gradient-primary-soft {
            background: linear-gradient(135deg, rgba(51,102,255,0.06) 0%, transparent 100%);
        }
        .dashboard-card {
            transition: transform 0.25s ease, box-shadow 0.25s ease;
        }
        .dashboard-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 32px rgba(0,0,0,0.18);
        }
        .stat-card {
            transition: transform 0.25s ease, box-shadow 0.25s ease;
        }
        .stat-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 32px rgba(0,0,0,0.18);
        }
        .table-hover tbody tr:hover {
            background-color: rgba(51,102,255,0.07);
        }
        .btn.shadow-sm:hover {
            transform: translateY(-1px);
        }
    </style>
}

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('searchInput');
            const pageSizeSelect = document.getElementById('pageSizeSelect');
            const searchBtn = document.getElementById('searchBtn');

            // Set current page size
            if (pageSizeSelect) pageSizeSelect.value = '@pageSize';

            const performSearch = () => {
                const term = searchInput?.value.trim() || '';
                const size = pageSizeSelect?.value || '@pageSize';
                window.location.href = `@Url.Action("Index")`
                    + `?page=1&pageSize=${size}&searchString=${encodeURIComponent(term)}`;
            };

            if (searchBtn) searchBtn.addEventListener('click', performSearch);
            if (searchInput) {
                searchInput.addEventListener('keypress', e => {
                    if (e.key === 'Enter') performSearch();
                });
            }
            if (pageSizeSelect) pageSizeSelect.addEventListener('change', performSearch);
        });
    </script>
}